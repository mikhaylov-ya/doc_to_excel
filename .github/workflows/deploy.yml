name: Deploy to Production

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:  # Allow manual trigger

jobs:
  deploy:
    name: Deploy to Host Server
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up SSH key
      run: |
        mkdir -p ~/.ssh
        # Write SSH key and ensure proper formatting
        printf '%s\n' "${{ secrets.DEPLOY_SSH_KEY }}" > ~/.ssh/deploy_key
        chmod 600 ~/.ssh/deploy_key
        # Verify key format
        ssh-keygen -l -f ~/.ssh/deploy_key || (echo "Invalid SSH key format" && exit 1)
        ssh-keyscan -H ${{ secrets.DEPLOY_HOST }} >> ~/.ssh/known_hosts
        chmod 644 ~/.ssh/known_hosts

    - name: Test SSH Connection
      run: |
        ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no ${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }} "echo 'SSH connection successful'"

    - name: Build Docker Image
      env:
        DOCKER_BUILDKIT: 1
      run: |
        echo "ðŸ—ï¸  Building Docker image on GitHub Actions runner..."
        docker build \
          --build-arg GOMAXPROCS=2 \
          -t doc-to-excel:latest \
          -f Dockerfile \
          .

        echo "ðŸ’¾ Saving Docker image to tar file..."
        docker save doc-to-excel:latest | gzip > doc-to-excel-image.tar.gz

        echo "ðŸ“Š Image size:"
        ls -lh doc-to-excel-image.tar.gz

    - name: Transfer Docker Image to Server
      env:
        DEPLOY_HOST: ${{ secrets.DEPLOY_HOST }}
        DEPLOY_USER: ${{ secrets.DEPLOY_USER }}
        DEPLOY_PATH: ${{ secrets.DEPLOY_PATH }}
      run: |
        echo "ðŸ“¤ Transferring Docker image to server..."
        # Use SCP with compression and fast cipher
        scp -C -c aes128-gcm@openssh.com \
          -o StrictHostKeyChecking=no \
          -o ConnectTimeout=30 \
          -o ServerAliveInterval=10 \
          -i ~/.ssh/deploy_key \
          doc-to-excel-image.tar.gz \
          ${DEPLOY_USER}@${DEPLOY_HOST}:${DEPLOY_PATH}/

    - name: Deploy Application
      env:
        DEPLOY_HOST: ${{ secrets.DEPLOY_HOST }}
        DEPLOY_USER: ${{ secrets.DEPLOY_USER }}
        DEPLOY_PATH: ${{ secrets.DEPLOY_PATH }}
      run: |
        ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no ${DEPLOY_USER}@${DEPLOY_HOST} << 'ENDSSH'
          set -e

          echo "ðŸ“ Navigating to deployment directory..."
          cd ${{ secrets.DEPLOY_PATH }}

          echo "ðŸ”„ Pulling latest changes..."
          git fetch origin
          git reset --hard origin/main

          echo "ðŸ“¦ Loading Docker image..."
          docker load < doc-to-excel-image.tar.gz

          echo "ðŸ§¹ Cleaning up image file..."
          rm -f doc-to-excel-image.tar.gz

          echo "ðŸ›‘ Stopping existing containers..."
          docker-compose down || true

          echo "ðŸš€ Starting new containers..."
          docker-compose up -d

          echo "ðŸ”¥ Ensuring firewall allows port 8080..."
          chmod +x firewall.sh
          ./firewall.sh || echo "âš ï¸ Firewall script failed, continuing anyway"

          echo "â³ Waiting for service to be healthy..."
          sleep 10

          echo "ðŸ¥ Checking health status..."
          curl -f http://localhost:8080/health || echo "âš ï¸ Health check warning"

          echo "âœ… Deployment successful!"
          docker-compose ps
        ENDSSH

    - name: Verify Deployment
      run: |
        echo "ðŸ” Verifying deployment on http://${{ secrets.DEPLOY_HOST }}:8080"
        sleep 5
        curl -f http://${{ secrets.DEPLOY_HOST }}:8080/health || echo "âš ï¸ Health check failed, but deployment may still be in progress"

    - name: Cleanup
      if: always()
      run: |
        rm -f ~/.ssh/deploy_key

    - name: Notify Success
      if: success()
      run: |
        echo "ðŸŽ‰ Deployment to ${{ secrets.DEPLOY_HOST }} completed successfully!"
        echo "ðŸ“ Service is running at: http://${{ secrets.DEPLOY_HOST }}:8080"

    - name: Notify Failure
      if: failure()
      run: |
        echo "âŒ Deployment failed. Check the logs above for details."
        exit 1
